# 1. Workflow Name
name: Playwright Tests CI

# 2. Trigger Events
on:
  push:
    branches: [ main, master ] # Runs on every push to main
  pull_request:
    branches: [ main, master ] # Runs on every Pull Request
  workflow_dispatch:          # Allows manual run from GitHub UI

jobs:
  test:
    runs-on: ubuntu-latest
    
    # Define environment variables at the JOB level so all steps can see them
    env:
      SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
      SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD }}

    steps:
    - uses: actions/checkout@v4 # Pulls your code

    - uses: actions/setup-node@v4 # Sets up Node.js
      with:
        node-version: 18

    - name: Install dependencies
      run: npm ci # Installs from package-lock.json

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    
    # Step E: Runs ONLY the sanity tests on Pull Requests
    - name: Run Sanity Tests
      if: github.event_name == 'pull_request'
      run: npx playwright test --grep @sanity

    # Step F: Runs the full suite on direct push to main
    - name: Run Full Regression
      if: github.event_name == 'push'
      run: npx playwright test

    # Step G: Always save the report for debugging
    - name: Upload Playwright Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30